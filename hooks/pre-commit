#!/bin/bash

# NextMCP Pre-commit Hook
# Runs linting and formatting checks before allowing commits

set -e

echo "ğŸ” Running pre-commit checks..."
echo ""

# Check if venv exists
if [ ! -d "venv" ]; then
    echo "âŒ Virtual environment not found. Please run: python3 -m venv venv"
    exit 1
fi

# 1. Run ruff linting with auto-fix
echo "ğŸ“‹ Running ruff linting..."
if ! venv/bin/ruff check --fix nextmcp/ tests/ examples/; then
    echo ""
    echo "âŒ Ruff linting failed. Please fix the errors above."
    exit 1
fi
echo "âœ… Ruff checks passed"
echo ""

# 2. Run black formatting
echo "ğŸ¨ Running black formatting..."
if ! venv/bin/black nextmcp/ tests/ examples/; then
    echo ""
    echo "âŒ Black formatting failed."
    exit 1
fi
echo "âœ… Black formatting applied"
echo ""

# 3. Run tests (quick check)
echo "ğŸ§ª Running tests..."
if ! venv/bin/python3 -m pytest tests/ -q --tb=line; then
    echo ""
    echo "âŒ Tests failed. Please fix failing tests before committing."
    exit 1
fi
echo "âœ… All tests passed"
echo ""

# Check if linting/formatting made changes
if ! git diff --quiet; then
    echo "âš ï¸  Linting/formatting made changes to your files."
    echo "   The changes have been applied but NOT staged."
    echo "   Please review the changes and stage them:"
    echo ""
    echo "   git add -u"
    echo "   git commit"
    echo ""
    exit 1
fi

echo "âœ¨ All pre-commit checks passed! Proceeding with commit..."
echo ""

exit 0
